{% extends "base.html" %}

{% block title %}Ú¯Ø²Ø§Ø±Ø´ Ù¾ÛŒØ´Ø±ÙØª{% endblock %}
{% block header %}ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ù¾ÛŒØ´Ø±ÙØª Ø´Ù…Ø§{% endblock %}

{% block content %}
    {% if goals %}
        <div class="accordion">
            {% for goal in goals %}
            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span>ğŸ¯ {{ goal.title }}</span>
                    <span>Ùª{{ "%.1f"|format(goal.completion_percentage) }}</span>
                </div>
                <div class="accordion-body">
                    <div class="goal-stats four-in-one">
                        <div>ğŸ¯ Ù‡Ø¯Ù Ú©Ù„: <strong>{{ "%.1f"|format(goal.total_units) }} ÙˆØ§Ø­Ø¯</strong></div>
                        <div>âœï¸ Ù¾ÛŒØ´Ø±ÙØª Ú©Ù„: <strong>{{ "%.2f"|format(goal.total_progress) }} ÙˆØ§Ø­Ø¯</strong></div>
                        <div>ğŸ“… Ø±ÙˆØ²Ù‡Ø§ÛŒ ÙØ¹Ø§Ù„: <strong>{{ goal.active_days }} Ø±ÙˆØ²</strong></div>
                        <div>ğŸ“Š Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø±ÙˆØ²Ø§Ù†Ù‡: <strong>{{ "%.2f"|format(goal.average_daily_progress) }} ÙˆØ§Ø­Ø¯</strong></div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="progress-bar-background mt-20">
                        <div class="progress-bar-fill" style="width: {{ goal.completion_percentage }}%;">
                            {{ "%.1f"|format(goal.completion_percentage) }}Ùª
                        </div>
                    </div>

                    {% if goal.progress_entries and goal.progress_entries|length > 0 %}
                    <div class="chart-container">
                        <canvas id="chart_{{ goal.id }}"></canvas>
                    </div>
                    {% else %}
                    <p class="text-placeholder">Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ù¾ÛŒØ´Ø±ÙØªÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù‡Ø¯Ù Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="card text-center">
            <p>Ø´Ù…Ø§ Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ù‡Ø¯ÙÛŒ ØªØ¹Ø±ÛŒÙ Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯. <a href="{{ url_for('add_goal') }}">Ø§ÙˆÙ„ÛŒÙ† Ù‡Ø¯Ù Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯</a>.</p>
        </div>
    {% endif %}
{% endblock %}

{% block scripts %}
    <!--load chart.js from first jsDelivr and second unpkg  -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        if (typeof Chart === 'undefined') {
            var fallbackScript = document.createElement('script');
            fallbackScript.src = "https://unpkg.com/chart.js";
            document.head.appendChild(fallbackScript);
        }
    </script>

    <script>
    function toggleAccordion(element) {
        element.classList.toggle('active');
        const body = element.nextElementSibling;
        body.style.display = body.style.display === 'block' ? 'none' : 'block';
    }

    const colors = {
        lineColor: '#0ABAB5',
        fillColor: 'rgba(10,186,181,0.1)',
        textColor: '#2c3e50'
    };

    {% for goal in goals %}
    {% if goal.progress_entries and goal.progress_entries|length > 0 %}
    (function() {
        const ctx = document.getElementById('chart_{{ goal.id }}');
        if (!ctx) return;
        const entries = [
            {% for e in goal.progress_entries|sort(attribute='date') %}
            { date: '{{ e.date }}', value: {{ e.value }} },
            {% endfor %}
        ];
        const labels = entries.map(e => e.date);
        const data = entries.map(e => e.value);

        new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: 'Ù¾ÛŒØ´Ø±ÙØª Ø±ÙˆØ²Ø§Ù†Ù‡',
                    data: data,
                    borderColor: colors.lineColor,
                    backgroundColor: colors.fillColor,
                    fill: true,
                    tension: 0.25,
                    pointRadius: 3,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Ù…Ù‚Ø¯Ø§Ø± Ù¾ÛŒØ´Ø±ÙØª' }
                    },
                    x: {
                        title: { display: true, text: 'ØªØ§Ø±ÛŒØ®' }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    })();
    {% endif %}
    {% endfor %}
    </script>
{% endblock %}

